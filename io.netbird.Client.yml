app-id: io.netbird.Client
runtime: org.freedesktop.Platform
runtime-version: '24.08'
sdk: org.freedesktop.Sdk
command: netbird-ui

finish-args:
  # Network access (required for VPN client)
  - --share=network
  # X11 and Wayland support for UI
  - --share=ipc
  - --socket=x11
  - --socket=wayland
  - --socket=fallback-x11
  # GPU access for UI rendering
  - --device=dri
  # Access to TUN device for VPN tunnel (requires host configuration)
  - --device=all
  # D-Bus access for system service communication
  - --system-talk-name=io.netbird.daemon
  - --talk-name=org.freedesktop.Notifications
  # Filesystem access for configuration
  - --filesystem=~/.config/netbird:create
  - --filesystem=/etc/netbird:ro
  # Environment variable to help with tray icon
  - --env=DISPLAY=:0

modules:
  - name: netbird
    buildsystem: simple
    only-arches:
      - x86_64
      - aarch64
    build-commands:
      - |
        echo "=== NetBird Build Diagnostics ==="
        echo "Architecture: $(uname -m)"
        echo "Current directory: $(pwd)"
        echo "Available files:"
        ls -la
        echo "================================="
        if [ ! -f netbird ]; then
          echo ""
          echo "ERROR: netbird binary not found!"
          echo ""
          echo "This usually means the download or extraction failed."
          echo "Troubleshooting steps:"
          echo "  1. Check your internet connection"
          echo "  2. Clear the build cache: rm -rf .flatpak-builder/"
          echo "  3. Try building with --verbose flag"
          echo "  4. Verify your architecture is supported (x86_64 or aarch64)"
          echo ""
          exit 1
        fi
        echo "Found netbird binary, proceeding with install..."
      - install -Dm755 netbird /app/bin/netbird
    sources:
      - type: archive
        only-arches:
          - x86_64
        url: https://github.com/netbirdio/netbird/releases/download/v0.61.0/netbird_0.61.0_linux_amd64.tar.gz
        sha256: eaa435a636297da6f082440d91bacce6221468c11d1127969fe6c132afc5879e
      - type: archive
        only-arches:
          - aarch64
        url: https://github.com/netbirdio/netbird/releases/download/v0.61.0/netbird_0.61.0_linux_arm64.tar.gz
        sha256: 815636c718a29d8ee9c852595d8576021e791d55fd67d6355cbdbc8c42889e1f

  # Note: netbird-ui is only available for x86_64 (upstream does not provide ARM64 Linux UI builds)
  - name: netbird-ui
    buildsystem: simple
    only-arches:
      - x86_64
    build-commands:
      - |
        echo "=== NetBird UI Build Diagnostics ==="
        echo "Architecture: $(uname -m)"
        echo "Current directory: $(pwd)"
        echo "Available files:"
        ls -la
        echo "====================================="
        if [ ! -f netbird-ui ]; then
          echo ""
          echo "ERROR: netbird-ui binary not found!"
          echo ""
          echo "This usually means the download or extraction failed."
          echo "Troubleshooting steps:"
          echo "  1. Check your internet connection"
          echo "  2. Clear the build cache: rm -rf .flatpak-builder/"
          echo "  3. Try building with --verbose flag"
          echo "  4. Note: netbird-ui is only available for x86_64"
          echo ""
          exit 1
        fi
        echo "Found netbird-ui binary, proceeding with install..."
      - install -Dm755 netbird-ui /app/bin/netbird-ui
    sources:
      - type: archive
        url: https://github.com/netbirdio/netbird/releases/download/v0.61.0/netbird-ui-linux_0.61.0_linux_amd64.tar.gz
        sha256: 14a7674bc5f4ad3578e9d2098b13d7ffe0ddb70fccb2367817c4124911e590c2

  # Fallback for ARM64: create a wrapper script since netbird-ui is not available
  - name: netbird-ui-fallback
    buildsystem: simple
    only-arches:
      - aarch64
    build-commands:
      - |
        cat > /app/bin/netbird-ui << 'EOF'
        #!/bin/sh
        echo "NetBird UI is not available for ARM64/aarch64 architecture."
        echo "The upstream project does not provide ARM64 Linux UI builds."
        echo ""
        echo "You can use the CLI instead:"
        echo "  flatpak run --command=netbird io.netbird.Client status"
        echo "  flatpak run --command=netbird io.netbird.Client up"
        echo "  flatpak run --command=netbird io.netbird.Client down"
        echo ""
        echo "Or run 'netbird' directly:"
        exec /app/bin/netbird "$@"
        EOF
        chmod 755 /app/bin/netbird-ui

  - name: metadata
    buildsystem: simple
    build-commands:
      - install -Dm644 io.netbird.Client.desktop /app/share/applications/io.netbird.Client.desktop
      - install -Dm644 io.netbird.Client.metainfo.xml /app/share/metainfo/io.netbird.Client.metainfo.xml
      - install -Dm644 netbird-icon-256.png /app/share/icons/hicolor/256x256/apps/io.netbird.Client.png
      - install -Dm644 netbird-icon.svg /app/share/icons/hicolor/scalable/apps/io.netbird.Client.svg
    sources:
      - type: file
        path: io.netbird.Client.desktop
      - type: file
        path: io.netbird.Client.metainfo.xml
      - type: file
        path: icons/netbird-icon-256.png
      - type: file
        path: icons/netbird-icon.svg
